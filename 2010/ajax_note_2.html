<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ajax Note Part II - SunsetSunrising</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0"/>
    <link rel="stylesheet" href="/assets/style.css?v=f8b86"/>
    <link rel="stylesheet" href="/assets/pygments.css?v=cedbb"/>
    
    <link rel="alternate" type="application/rss+xml" href="/feed.xml" title="SunsetSunrising"/>
    
<link rel="canonical" href="/2010/ajax_note_2.html" />



    <script>
        (function() {
            var cx = '012347804910294994683:rsexabosj44';
            var gcse = document.createElement('script'); gcse.type = 'text/javascript'; gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
                    '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(gcse, s);
        })();
    </script>
</head>
<body>
<!--http://vimeo.com/53043267-->
<div id="topbar"></div>
<header>
    <div id="logo"><a href="/"><img src="/assets/sunsetsunrising.png" alt="SunsetSunrising" /></a></div>
    <nav id="nav" role="navigation">
        
        <a  href="/">Home</a>
        <a  href="/resume/zh.html">Resume</a>
    </nav>
</header>
<div id="search">
    <gcse:searchbox enableHistory="true" autoCompleteMaxCompletions="5" autoCompleteMatchType='any'></gcse:searchbox>
</div>
<div id="search-results">
    <gcse:searchresults refinementStyle="link"  adclient="pub-3716363443644786"></gcse:searchresults>
</div>
<div class="container"><h1 class="entry-title">Ajax Note Part II</h1>
<div class="entry-meta">
    <time class="updated" datetime="2010-01-07T10:01:12+08:00">
        <a href="/2010/">2010-01-07</a>
    </time>
    <span class="author vcard">
        by <a class="url fn" href="http://sunsetsunrising.com">Yan Sheng</a>
        
    </span>
</div>
<div class="entry-content">
    <div class="highlight"><pre><span class="k">try</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">xmlhttp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
<span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">xmlhttp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ActiveXObject</span><span class="p">(</span><span class="s2">&quot;Microsoft.XMLHTTP&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;/ajax/helloworld/&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">){</span>
        <span class="nx">alert</span><span class="p">(</span><span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;words&quot;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
</pre></div>
<p>定义</p>
<ul class="simple">
<li>new XMLHttpRequest();</li>
<li>new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;);</li>
</ul>
<p>初始化一个请求</p>
<ul class="simple">
<li>XMLHttpRequest.open(method, url, 是否异步);</li>
<li>XMLHttpRequest.open(strMethod, strUrl, boolAsync, strUser, strPassword); // 需要验证时的用户名和密码</li>
<li>boolAsync, true, 异步方式, 当状态改变时会调用onreadystatechange</li>
</ul>
<p>设置请求的HTTP头信息</p>
<ul class="simple">
<li>XMLHttpRequest.setRequestHeader(strHeader, strValue);</li>
<li>Content-Type: text/xml or application/x-www-form-urlencoded</li>
<li>COOKIE: cookiename = cookievalue</li>
</ul>
<p>发送请求</p>
<ul class="simple">
<li>XMLHttpRequest.send(varBody)</li>
<li>通过请求发送的数据, 字符串, DOM, 任意数据流</li>
</ul>
<p>XMLHttpRequest对象在生命周期中有5种状态:</p>
<p># 0(未初始化) 对象已创建, 但未调用open初始化
# 1(初始化) 对象已初始化, 但未调用send
# 2(发送数据) send已调用, 但HTTP状态和HTTP未知
# 3(数据传送中) 已开始接受数据, 但响应数据和HTTP头信息不全
# 4(完成) 数据接收完成</p>
<ul class="simple">
<li>.readyState 指示上述5种状态</li>
<li>.status 返回请求的HTTP状态码</li>
<li>readystatechange事件调用onreadystatechange处理函数</li>
<li>.getResponseHeader(&quot;xxx&quot;); //获得信息的HTTP头</li>
<li>.getAllResponseHeaders(); // 获得信息的所有HTTP头</li>
<li>取得返回的数据: responseText(作为字符串格式), responseXML(XML文档)</li>
<li>.abort(); // 重新返回到未初始化状态</li>
</ul>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">parseXMLData</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// data为XML格式</span>
    <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">){</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">+=</span> <span class="s2">&quot;&lt;div&gt;&quot;</span><span class="o">+</span><span class="nx">data</span><span class="p">.</span><span class="nx">nodeName</span><span class="o">+</span><span class="s2">&quot;&lt;/div&gt;&quot;</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
            <span class="nx">parseXMLData</span><span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">+=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">nodeName</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">nodeValue</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * 一个基本的封装好的Ajax开发框架</span>
<span class="cm"> *</span>
<span class="cm"> * @author:</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * 对不同浏览器下XMLHttpRequest对象的简单封装</span>
<span class="cm"> * @function    getTransport</span>
<span class="cm"> * @constructor</span>
<span class="cm"> * @returns     XMLHttpRequest对象 or undefined</span>
<span class="cm"> */</span>
<span class="kd">function</span> <span class="nx">getTransport</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">version</span> <span class="o">=</span> <span class="p">[</span>
        <span class="kd">function</span><span class="p">(){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
        <span class="p">},</span>
        <span class="kd">function</span><span class="p">(){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">ActiveXObject</span><span class="p">(</span><span class="s1">&#39;Microsoft.XMLHTTP&#39;</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="kd">function</span><span class="p">(){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">ActiveXObject</span><span class="p">(</span><span class="s1">&#39;Microsoft.XMLHTTP&#39;</span><span class="p">);</span>
        <span class="p">}];</span>

    <span class="kd">var</span> <span class="nx">request</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">version</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">lambda</span> <span class="o">=</span> <span class="nx">version</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">try</span><span class="p">{</span>
            <span class="nx">request</span> <span class="o">=</span> <span class="nx">lambda</span><span class="p">();</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">request</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * 根据用户指定的URL，方法，参数，HTTP头，及回调函数，创建XMLHttpRequest对象并发送请求</span>
<span class="cm"> * @function ajaxRequest</span>
<span class="cm"> * @param {string} url 请求的URL地址</span>
<span class="cm"> * @param {object} options 参数集合</span>
<span class="cm"> */</span>
<span class="kd">function</span> <span class="nx">ajaxRequest</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">options</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">getTransport</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">request</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">){</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Browser does not Supper&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">method</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">method</span> <span class="o">||</span> <span class="s2">&quot;POST&quot;</span><span class="p">).</span><span class="nx">toUpperCase</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">method</span> <span class="o">!=</span> <span class="s2">&quot;GET&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">method</span> <span class="o">!=</span> <span class="s2">&quot;POST&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">method</span> <span class="o">=</span> <span class="s2">&quot;POST&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">parameters</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">parameters</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">headers</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">headers</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">onLoadingEventHandler</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onLoading</span> <span class="o">||</span> <span class="kd">function</span><span class="p">(){};</span>
    <span class="kd">var</span> <span class="nx">onCompleteEventHandler</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onComplete</span> <span class="o">||</span> <span class="kd">function</span><span class="p">(){};</span>
    <span class="kd">var</span> <span class="nx">onSuccessEventHandler</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onSuccess</span> <span class="o">||</span> <span class="kd">function</span><span class="p">(){};</span>
    <span class="kd">var</span> <span class="nx">onFailureEventHandler</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onFailure</span> <span class="o">||</span> <span class="kd">function</span><span class="p">(){};</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">method</span> <span class="o">==</span> <span class="s2">&quot;GET&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">parameters</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span><span class="o">&gt;-</span><span class="mi">1</span><span class="p">){</span>
            <span class="nx">url</span> <span class="o">+=</span> <span class="s1">&#39;&amp;&#39;</span> <span class="o">+</span> <span class="nx">parameters</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">url</span> <span class="o">+=</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="nx">parameters</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">parameters</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">&quot;contentType&quot;</span><span class="p">,</span> <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">headers</span><span class="p">){</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">setrequestHeder</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">headers</span><span class="p">[</span><span class="nx">name</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
            <span class="nx">onLoadingEventHandler</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span><span class="p">){</span>
            <span class="nx">onCompleteEventHandler</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">status</span> <span class="o">&amp;&amp;</span> <span class="nx">request</span><span class="p">.</span><span class="nx">status</span><span class="o">&gt;=</span><span class="mi">200</span> <span class="o">&amp;&amp;</span> <span class="nx">request</span><span class="p">.</span><span class="nx">status</span><span class="o">&lt;</span><span class="mi">300</span><span class="p">){</span>
                <span class="nx">onSuccessEventHandler</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">onFailureEventHandler</span><span class="p">(</span><span class="nx">request</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">parameters</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
<p>编码:</p>
<blockquote>
XMLHttpRequest返回数据是按UTF-8编码, 保持前后台一致, 即请求头和响应头编码一致就不会有问题</blockquote>
<p>缓存:</p>
<blockquote>
对请求url加个随机变化的参数</blockquote>
<p>请求方式:</p>
<blockquote>
POST, 创建, 更新资源, 有副作用
GET, 查询, 无副作用, 长度限制1024字节</blockquote>
<p>控制多个ajax请求</p>
<blockquote>
<ul class="simple">
<li>轮询模式: 将下一次请求的发起放在上一个请求完成的回调函数中</li>
<li>事件响应模式: 等用户完成输入或者到达预期的位置后才发送必要的请求, 但是开发者并不能预先知道用户需要什么,,,,可以给每次请求设置延迟, 在每次事件中, 设置一个延迟来发送请求, 在下一次事件中预先判断是否存在仍然处于延迟阶段,未被发送的请求, 如果存在, 则取消这个请求的发送, 然后重新设置一个新的延迟发送的请求, 延迟的时间间隔视需要而定(可将延迟时间设置为略大于用户每步操作的平均时间间隔)</li>
</ul>
</blockquote>
<p>AJAX请求安全性:</p>
<blockquote>
一是身份验证
二是后台检测输入的内容有效性
三是防范js注入, 同样也是建立有效的检测校验机制</blockquote>
<dl class="docutils">
<dt>XML</dt>
<dd>&lt;![CDATA[ ... ]]&gt;
包含的文本被当作普通文本处理</dd>
</dl>
<p>ZXml:</p>
<blockquote>
跨浏览器的XML开发框架</blockquote>
<p>JSON vs XML</p>
<p>JSON:</p>
<blockquote>
<ul class="simple">
<li>更简洁, 字节数少</li>
<li>解析方便, 与js对象一致</li>
<li>结构简单</li>
<li>但没有像XML的命名空间机制</li>
</ul>
<p>xml2json: 将xml文档转成json</p>
</blockquote>
<div class="section" id="oop">
<h2>OOP</h2>
<p>类</p>
<ul class="simple">
<li>this.添加的属性都是public的</li>
<li>局部变量可认为是私有变量, 由作用域控制</li>
<li>静态属性和方法, 直接给类名, eg, A.aaa = ...; A.b = function(){}</li>
<li>原型对象prototype, 每个对象可以参考一个原型对象, 原型对象包含自己的属性, 按照需要随时对类进行扩展无须改动原有的定义</li>
</ul>
<div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * 类的使用</span>
<span class="cm"> */</span>
<span class="kd">function</span> <span class="nx">People</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">sex</span><span class="p">,</span> <span class="nx">deposit</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">sex</span> <span class="o">=</span> <span class="nx">sex</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">deposit</span> <span class="o">=</span> <span class="nx">deposit</span><span class="p">;</span> <span class="c1">//私有属性</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">changeName</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">newName</span><span class="p">){</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">newName</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">consume</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">money</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">deposit</span><span class="o">&gt;=</span><span class="nx">money</span><span class="p">){</span>
            <span class="nx">deposit</span> <span class="o">-=</span> <span class="nx">money</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Not Enough&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">_this</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">digest</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">food</span><span class="p">){</span> <span class="c1">//私有方法</span>
        <span class="nx">_this</span><span class="p">.</span><span class="nx">thew</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">eat</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">food</span><span class="p">){</span> <span class="c1">//共有方法</span>
        <span class="nx">digest</span><span class="p">(</span><span class="nx">food</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">People</span><span class="p">.</span><span class="nx">staticProperty</span> <span class="o">=</span> <span class="s2">&quot;static property&quot;</span><span class="p">;</span> <span class="c1">//静态属性</span>
<span class="nx">People</span><span class="p">.</span><span class="nx">staticMethod</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){}</span> <span class="c1">//静态方法</span>

<span class="nx">People</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1">// 原型</span>
    <span class="nx">thew</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="nx">changeName</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">newName</span><span class="p">){</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">Name</span> <span class="o">=</span> <span class="nx">newName</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">People</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">shout</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){};</span>

<span class="c1">// 对象冒充</span>
<span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">People</span><span class="p">(</span><span class="s2">&quot;J&quot;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">People</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">);</span>
<span class="nx">j</span><span class="p">.</span><span class="nx">getName</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span> <span class="c1">// &quot;A&quot;</span>
<span class="nx">a</span><span class="p">.</span><span class="nx">getName</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">j</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">Shape</span><span class="p">(</span><span class="nx">name</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">getName</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="k">return</span> <span class="nx">name</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">Circle</span><span class="p">(</span><span class="nx">center</span><span class="p">,</span> <span class="nx">radius</span><span class="p">){</span>
    <span class="nx">Shape</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s2">&quot;circle&quot;</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">center</span> <span class="o">=</span> <span class="nx">center</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">radius</span> <span class="o">=</span> <span class="nx">radius</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">//对于父类的原型，子类继承时，</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">member</span> <span class="k">in</span> <span class="nx">Shape</span><span class="p">.</span><span class="nx">prototype</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Circle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">member</span><span class="p">]){</span>
        <span class="nx">Circle</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">member</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Shape</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">member</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * 简单封装继承</span>
<span class="cm"> */</span>
<span class="nb">Function</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">inherit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">baseClass</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_baseClass</span> <span class="o">=</span> <span class="nx">baseClass</span><span class="p">;</span>
    <span class="nx">baseClass</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="c1">// 使用对象冒充调用基类的构造函数</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">member</span> <span class="k">in</span> <span class="nx">baseClass</span><span class="p">.</span><span class="nx">prototype</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">member</span><span class="p">]){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">member</span><span class="p">]</span> <span class="o">=</span> <span class="nx">baseClass</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">member</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// 对于Circle，使用如下方式继承Shape</span>
<span class="kd">function</span> <span class="nx">Circle</span><span class="p">(</span><span class="nx">center</span><span class="p">,</span> <span class="nx">radius</span><span class="p">){</span>
    <span class="nx">Circle</span><span class="p">.</span><span class="nx">inherit</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">Shape</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;circle&quot;</span><span class="p">]);</span>
    <span class="c1">//...</span>
<span class="p">}</span>

<span class="c1">// 命名空间</span>
<span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">Sys</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">){</span>
    <span class="nx">Sys</span> <span class="o">=</span> <span class="p">{};</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">Sys</span> <span class="o">!=</span> <span class="s2">&quot;object&quot;</span><span class="p">){</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;type error&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// 子命名空间</span>
<span class="nx">Sys</span><span class="p">.</span><span class="nx">Utility</span> <span class="o">=</span> <span class="p">{};</span>
<span class="nx">Sys</span><span class="p">.</span><span class="nx">Utility</span><span class="p">.</span><span class="nx">StringBuilder</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){}</span>

<span class="c1">// 短命名</span>
<span class="kd">function</span> <span class="nx">imports</span><span class="p">(</span><span class="nx">namespace</span><span class="p">){</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">member</span> <span class="k">in</span> <span class="nx">namespace</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="p">[</span><span class="nx">member</span><span class="p">]){</span>
            <span class="nb">window</span><span class="p">[</span><span class="nx">member</span><span class="p">]</span> <span class="o">=</span> <span class="nx">namespace</span><span class="p">[</span><span class="nx">member</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">imports</span><span class="p">(</span><span class="nx">Sys</span><span class="p">.</span><span class="nx">Utility</span><span class="p">);</span>
</pre></div>
<p>JSVM:</p>
<blockquote>
完整的代码组织管理方案</blockquote>
</div>
<div class="section" id="id1">
<h2>浏览器兼容性示例</h2>
<ul class="simple">
<li>form.elements 获取表单元素集合</li>
<li>.getAttribute(&quot;XXX&quot;);</li>
<li>window.open(); 来打开新的窗口, 不用什么乱七八糟的模态窗口</li>
<li>window.frameName.location = &quot;XXX&quot;; 使用iframe的名字, 不用它的id</li>
</ul>
<div class="highlight"><pre><span class="c1">// 父元素使用parentNode</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">ActiveXObject</span><span class="p">){</span>
    <span class="c1">// outerText兼容性问题解决</span>
    <span class="nx">HTMLElement</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_defineGetter_</span><span class="p">(</span><span class="s2">&quot;outerText&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">textContent</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="nx">HTMLElement</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_defineSetter_</span><span class="p">(</span><span class="s2">&quot;outerText&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">textNode</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">replaceChild</span><span class="p">(</span><span class="nx">textNode</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="c1">// innerText</span>
    <span class="nx">HTMLElement</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_defineGetter_</span><span class="p">(</span><span class="s2">&quot;innerText&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="k">return</span> <span class="p">;</span>
    <span class="p">});</span>
    <span class="nx">HTMLElement</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_defineSetter_</span><span class="p">(</span><span class="s2">&quot;innerText&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="c1">// outerHTML</span>
    <span class="nx">HTMLElement</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_defineGetter_</span><span class="p">(</span><span class="s2">&quot;outerHTML&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="kd">var</span> <span class="nx">attr</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">attrs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
            <span class="nx">attr</span> <span class="o">=</span> <span class="nx">attrs</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">attr</span><span class="p">.</span><span class="nx">specified</span><span class="p">){</span>
                <span class="nx">str</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">attr</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;=&quot;&#39;</span> <span class="o">+</span> <span class="nx">attr</span><span class="p">.</span><span class="nx">value</span> <span class="o">+</span><span class="s1">&#39;&quot;&#39;</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">str</span> <span class="o">+=</span> <span class="s1">&#39;&gt;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">+</span> <span class="s2">&quot;&lt;/&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">str</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="nx">HTMLElement</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_defineSetter_</span><span class="p">(</span><span class="s2">&quot;outerHTML&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sHTML</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">range</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ownerDocument</span><span class="p">.</span><span class="nx">createRange</span><span class="p">();</span>
        <span class="nx">range</span><span class="p">.</span><span class="nx">setStartBefore</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">domFragment</span> <span class="o">=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">createContextualFragment</span><span class="p">(</span><span class="nx">sHTML</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">replaceChild</span><span class="p">(</span><span class="nx">domFragment</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
<ul>
<li><p class="first">解决Ajax和搜索引擎收录问题:</p>
<blockquote>
<ul class="simple">
<li>区分对象, 普通http请求和ajax请求;</li>
<li>对ajax, a标签注册click事件, 以href值进行ajax请求;</li>
<li>对爬虫, 仍然是普通链接.</li>
</ul>
</blockquote>
</li>
<li><p class="first">Ajax的前进和后退问题:</p>
<blockquote>
<ul class="simple">
<li>Gecko核心: url加#号后的hash值, 改变后, 直接触发firefox的historyChange函数</li>
<li>IE: 如果一个页面包含一个或者多个iframge, 若iframge中页面发生了跳转, 那么也会被浏览器记录到历史记录中, 如果单击浏览器的前进和后退, 主页面不受影响, 智慧让iframe中的页面发生跳转, 那么, 可以将#后的hash值交给iframe保存, ajax请求并更新界面时, 改变iframe地址...比较含糊.</li>
</ul>
</blockquote>
</li>
</ul>
</div>

</div>
<div class="entry-tags">
    <a href="/tag/#Javascript">Javascript</a><a href="/tag/#note">note</a>
</div>


<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'sunsetsunrising';
    var disqus_title = 'Ajax Note Part II';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
</div>
<footer>
    <hr class="end"/>
    <p>&copy;2008~2012  <a href="https://github.com/lizzie/lizzie.github.com">Liz</a>  &hearts; <span class="software">Powered by <a href="http://lab.lepture.com/liquidluck/">Felix Felicis 3.5</a></span></p>
</footer>

<script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-4419044-5']);
    _gaq.push(['_trackPageview']);
    _gaq.push(['_trackPageLoadTime']);
    (function () {
        var ga = document.createElement('script');
        ga.type = 'text/javascript';
        ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(ga, s);
    })();
</script>
</body>
</html>