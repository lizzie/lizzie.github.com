<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GAE Index Problem - SunsetSunrising</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0"/>
    <link rel="stylesheet" href="/assets/style.css?v=a6013"/>
    <link rel="stylesheet" href="/assets/pygments.css?v=cedbb"/>
    
    <link rel="alternate" type="application/rss+xml" href="/feed.xml" title="SunsetSunrising"/>
    
<link rel="canonical" href="/2009/index_problem.html" />


</head>
<body>
<!--http://vimeo.com/53043267-->
<div id="topbar"></div>
<header>
    <div id="logo"><a href="/">SunsetSunrising</a></div>
    <nav id="nav" role="navigation">
        
        <a  href="/">Home</a>
        <a  href="/about.html">About</a>
    </nav>
    <div id="search">
        <form action="" id="J_search" class="form-search">
            <input type="text" class="query" placeholder="Search"/>
            <button type="submit" class="btn">Go</button>
        </form>
    </div>
</header>
<div class="container"><h1 class="entry-title">GAE Index Problem</h1>
<div class="entry-meta">
    <time class="updated" datetime="2009-12-15T14:12:25+08:00">
        <a href="/2009/">2009-12-15</a>
    </time>
    <span class="author vcard">
        by <a class="url fn" href="http://sunsetsunrising.com">Yan Sheng</a>
        
    </span>
</div>
<div class="entry-content">
    <div class="section" id="id1">
<h2>目的</h2>
<p>GAE应用中, 如果有定义数据库models, 并且有查询语句的话, 会使用到Index.yaml中的相关设置. 她主要用于告诉GAE, 这个应用中的所有查询语句(Gql, filter等)中使用到哪些数据表, 哪些字段, 按照什么排序. 这样做主要是为了&quot;allow speedy access to the data in your datastore&quot;, 也就是加快访问数据库的速度. 这可能是由于google的&quot;数据库&quot;有点特别...</p>
</div>
<div class="section" id="id2">
<h2>示例</h2>
<p>index.yaml的内容一般类似于:</p>
<blockquote>
<pre class="literal-block">
indexes:
- kind: Person
  properties:
  - name: last_name
  - name: height
    direction: desc
</pre>
</blockquote>
<p>这个表示说, 程序中有一个查询是对Person这个表进行, 查询中用到字段last_name, height, 然后结果按照height的逆序返回.</p>
<p>而在appengine管理后台, 对于每个应用的Data Store Indexes中描述的, 如下图, 就是和index.yaml一致的.</p>
</div>
<div class="section" id="id3">
<h2>如何生成</h2>
<p>一般, 这个index.yaml头部有个&quot;#AUTOGENERATED&quot;, 表示自动生成, 也就是说程序运行时, 根据查询代码自动更新. 在本地开发时, 运行dev_appserver.py, 一般都会生成. 当然也可以将自动生成去掉, 这样我们可以手工定义.
更多的信息可见 <a class="reference external" href="http://code.google.com/appengine/docs/python/datastore/queriesandindexes.html#Introducing_Indexes">这里</a></p>
</div>
<div class="section" id="id5">
<h2>遇到的问题</h2>
<p>今天在调试中出现两个问题:</p>
<p>1, 出错信息1, 这是我在使用order(&quot;-date&quot;)时出现的错误, 说是排序属性需和过滤属性一致. 也就是filter时是category的话, 排序时也得按照category排序. 而不能直接像django中orm的filter(xxx).order(yyy). xxx和yyy得是同一个字段.</p>
<blockquote>
BadArgumentError: First ordering property must be the same as inequality filter property, if specified for this query; received date, expected category</blockquote>
<p>但我看 <a class="reference external" href="http://code.google.com/appengine/docs/python/datastore/queryclass.html#Introduction">文档</a> 上, 有类似filter(xxx).order(yyy)的例子, 奇怪的是, 到我这边写了, 总是报这个错误, 无奈我只能把所有order去掉.</p>
<p>2, 出错信息2,</p>
<blockquote>
NeedIndexError: no matching index found. This query needs this index: - kind: Photo properties: - name: category - name: category - name: isHome - name: category</blockquote>
<p>这个就相对简单些了, 就是说缺少Index错误, 没有找到匹配的index定义. 也就是说, 程序中的查询没有在index.yaml中找到匹配的. 这个只要增加类似如上的index描述就可以了. 或者直接让他自动生成吧.</p>
<p>ps, 自动生成有个不好的地方就是, 比如一个query,</p>
<blockquote>
allphoto = Photo.all()
photo1 = allphoto.filter('cateogry = ', 'aaa')
photo2 = allphoto.filter('cateogry = ', 'bbb')
photo3 = allphoto.filter('cateogry = ', 'ccc')</blockquote>
<p>自动生成会是这样子:</p>
<blockquote>
<pre class="literal-block">
- kind: Photo
  properties:
  - name: cateogry
  - name: cateogry
  - name: cateogry
...
</pre>
</blockquote>
<p>也就是会出现n多重复的东西. 看来还是和django的orm不同, 所以最好将每个查询分开来~</p>
</div>

</div>
<div class="entry-tags">
    <a href="/tag/#GAE">GAE</a>
</div>

</div>
<footer>
    <hr class="end"/>
    <p>&copy;2008~2012 Liz.</p>
</footer>

<script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-4419044-5']);
    _gaq.push(['_trackPageview']);
    _gaq.push(['_trackPageLoadTime']);
    (function () {
        var ga = document.createElement('script');
        ga.type = 'text/javascript';
        ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(ga, s);
    })();
</script>
</body>
</html>